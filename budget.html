<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal</title>
    <link rel="stylesheet" href="./styles.css"> 
    <script src="./script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
</script>
</head>
<body onload="addBudget()">
    <div class="index">
        <nav class="menu">
            <a class="menu_item1" href="./itinerary.html"> Itinerary</a>
            <a class="menu_item2" href="./journal.html">Journal</a>
            <a class="menu_item3" href="budget.html">Budget</a>
            <a class="menu_item4">Calender</a>
            <a class="menu_item5">Map</a>
        </nav>
            <a class="title" href="./index.html">TravelApp</a>
        <div class="content" id="budget_content">
            <div class="budget_graph"> 
                <canvas id="myChart"></canvas>
            </div>
            <div class="budget_items">
                <button onclick="addBudget()" class="small_button">+ Add Entry</button>
                <div id="budget_enter">
                    <div class="budget_catagory">
                        <label>Catagory</label>          
                        <select class="budget_catag">
                            <option></option>
                            <option>Lodging</option>
                            <option>Transportation</option>
                            <option>Food</option>
                            <option>Others</option>
                        </select>   
                    </div>
                    <div class="budget_catagory">
                        <label>Amount</label>
                        <textarea class="budget_amount"></textarea>
                    </div>
                    <div class="budget_catagory">
                        <label>Date</label>
                        <input type="datetime-local" class="budget_date">
                    </div>
                    <div class="budget_catagory">
                        <label>Label</label>
                        <textarea id="budget_label"></textarea>
                    </div>
                    <button class="budget_button small_button" onclick="AddBudgetItem()">Add Expense</button>
                    <button class="budget_button small_button" onclick="addBudget()">Cancel</button>
                </div>
                <div id="budget_spacer"></div>
                <div class="budget_entry">
                    
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    var totalAmount;
    var BudgetCata = {Lodging: 0, Transportation: 0, Food: 0, Others: 0};
    var budgetItems = []; 
    const ctx = document.getElementById('myChart');
    const data = {
        labels: ['Lodging', 'Transportation', 'Food', 'Others'],
        datasets: [{
            label: 'Budget',
            data: [BudgetCata.Lodging, BudgetCata.Transportation, BudgetCata.Food, BudgetCata.Others],
            backgroundColor: ['rgb(255, 0, 0, 0.4)', 'rgb(255, 98, 0, 0.4)', 'rgb(242, 255, 0, 0.4)', 'rgb(158, 50, 168, 0.4)'],
            hoverOffset: 4
        }]  
    };

    var chart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        onClick: (e, activeEls) => {
            console.log(e);
            console.log(activeEls[0]);
            //let dsIndex = activeEls[0]._datasetIndex;
            //console.log(dsIndex);
            let dataIndex = activeEls[0]._index;
            let indexValue = (dataIndex == '0') ? 'Lodging' : 
                (dataIndex == '1') ? 'Transportation' :
                (dataIndex == '2') ? 'Food' : 'Others';
            //console.log(dataIndex);
            //console.log(budgetItems);
            //console.log(budgetItems[0].catagory);

            const amount = document.querySelector('.budget_amount').value;
            const catagory = document.querySelector('.budget_catag').value;
            const date = document.querySelector('.budget_date');
            const label = document.getElementById('budget_label');
            document.querySelector('.budget_entry').innerHTML = `<div>${indexValue}</div>`;

            budgetItems.forEach(item => {
                if(item.catagory == indexValue) {
                    document.querySelector('.budget_entry').innerHTML += 
                    `<div class="card"><p>${item.label}: $${item.amount}</p>
                    <small class="dateTime">${item.date}</small></div>`
                }
            });
            
            /*
            let datasetLabel = chart.data.datasets[dsIndex] //e.chart.data.datasets[datasetIndex].label;
            console.log(datasetLabel);
            let value = e.chart.data.datasets[dsIndex].data[dataIndex];
            console.log("In click", datasetLabel, value);
            //link to url with:[chartIds]      
            */      
        }
        //maintainAspectRatio: true,
      },
      plugins: [{
          id: 'text',
          beforeDraw: function(chart, a, b) {
            var width = chart.width,
                height = chart.height,
                ctx = chart.ctx;

            ctx.restore();
            var fontSize = (height / 114).toFixed(2);
            ctx.textBaseline = "middle"; 
            totalAmount = BudgetCata.Lodging + BudgetCata.Transportation + BudgetCata.Food + BudgetCata.Others;
            var text = 'Total: $' + totalAmount,
                textX = Math.round((width - ctx.measureText(text).width) / 2),
                textY = height / 2;

            ctx.fillText(text, textX, textY);
            ctx.save();
          }
      }]
    });
    //console.log(Lodging.valueOf());

    function AddBudgetItem() {
        const amount = document.querySelector('.budget_amount').value;
        const catagory = document.querySelector('.budget_catag').value;
        const date = document.querySelector('.budget_date').value;
        const label = document.getElementById('budget_label').value;

        switch (catagory) {
            case 'Transportation': 
            BudgetCata.Transportation += parseFloat(parseFloat(amount).toFixed(2));
            budgetItems.push({catagory, label, amount, date});
            //console.log(budgetItems);
            break;

            case 'Lodging': 
            BudgetCata.Lodging += parseFloat(parseFloat(amount).toFixed(2));
            budgetItems.push({catagory, label, amount, date});
            break;

            case 'Others': 
            BudgetCata.Others += parseFloat(parseFloat(amount).toFixed(2));
            budgetItems.push({catagory, label, amount, date});
            break;

            case 'Food': 
            BudgetCata.Food += parseFloat(parseFloat(amount).toFixed(2));
            budgetItems.push({catagory, label, amount, date});
            break;

            default: 
            console.log('should not show');
        };

        console.log(budgetItems);

        amount.value = '';
        catagory.value = '';
        date.value = 'mm/dd/yyyy';
 
        chart.data.datasets[0].data = [BudgetCata.Lodging, BudgetCata.Transportation, BudgetCata.Food, BudgetCata.Others];
        chart.update();
    }

  </script>
   
